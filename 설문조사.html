<link rel="stylesheet" href="https://ggaribox.s3.ap-northeast-2.amazonaws.com/survey.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.4.1/css/swiper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.4.1/js/swiper.min.js"></script>

<div class="container-fluid">
    <div class="row align-items-center h_100 bg_point">
        <div class="col">

            <!-- 시작 -->
            <div id="opening" class="container-fluid mw_1200 survey_pages">
                <div class="row align-items-center h-100 ">
                    <div class="col-12 text-right pt_2rem pr-4 mpt-4 mobile">
                        <button type="button" class="btn ">
                            <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/close.png" alt="" class="img-fluid">
                        </button>
                    </div>
                    <div class="col-12 px_100 pt_180 ">
                        <div class="fs_40 line_50">
                            까리!<br>
                            <span class="fw_700 pc">우리 반려묘의 건강을 알려줘!</span>
                            <span class="fw_700 mobile">우리 반려묘의<br>건강을 알려줘!</span>
                        </div>
                        <div class="fs_28 pt-5">
                            몇 가지 설문조사 질문에 답하고 우리 주인님에게 필요한 영양 간식을 알아보세요.<br>
                            <div class="m_pt_10">최대 3분정도 소요됩니다. <span class="fw_700">그럼 시작해볼까요?</span></div>
                        </div>
                        <div class="fs_16 color_888 pt-4">
                            *정확한 진단 및 치료방법은 전문적인 의료기관을 이용하세요.
                        </div>
                        <div class="text-center pt-9 pb-7">
                            <a onclick="survey.movePage('#selecting')">
                                <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/start_button.png" alt="" class="img-fluid next_shadow">
                            </a>
                        </div>
                    </div>
                </div>
            </div>     

            <div id="progress_box" class="container-fluid mw_1200 d-none">
                <div class="align-items-center">
                    <div class="col-12 text-right pt_2rem pr-4 mpt-4 mobile">
                        <button type="button" class="btn ">
                            <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/close.png" alt="" class="img-fluid">
                        </button>
                    </div>
                    <div class="col-12 text-center pt-5 progress_mobile">
                        <span id=announce0 class="fs_18 color_fff bg_point progress_bar">
                            <span class="fw_700">설문조사</span>
                            를 시작하기 전에...
                        </span>
                        <span id=announce1 class="fs_18 color_fff bg_point progress_bar d-none">
                            <span class="fw_700 selected_cat_name"></span>
                            의 설문조사 진행중...
                        </span>
                    </div>
                    <div class="col-12 px_100 pt-5_2">
                        <div class="text-center">
                            <div class="pop_loading_box">
                                <div class="pop_loader_top anime_floating"></div>
                                <div class="pop_loader">
                                    <div id="pop_loader_bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 text-center mw_1000 px-0 pt-3">
                        <div class="row  text-center">
                            <div class="col fs_16 fw_700 point_color text-center">
                                기본정보</div>
                            <div class="col fs_16 fw_700 color_subgray text-center">
                                질병/증상</div>
                            <div class="col fs_16 fw_700 color_subgray text-center">
                                생활습관</div>
                            <div class="col fs_16 fw_700 color_subgray text-center">
                                기타</div>
                        </div>
                    </div>
                    <div class="col-12 px-0 point_color_alpha h_2 mt-3">                            
                    </div>    
                </div>
            </div>

            <!-- 고양이선택 -->
            <div id="selecting" class="container-fluid mw_1200 survey_pages d-none">
                <div class="row align-items-center h-100 under_bar_box">
                    <div class="col-12 px-6 pt_40px">
                        <div class=" fs_24 fw_700">
                            어떤 반려묘를 조사해볼까요?
                        </div>
                    </div>

                    <div class="swiper2_wrap pt_40px">
                        <!-- Swiper -->
                        <div class="swiper catname_swiper">
                            <div class="swiper-wrapper">
                                <div id="cat_card0" class="swiper-slide slide2">
                                    <div class="pop_box_open pop_w" onclick="survey.checkToCreating(true)">
                                        <div class=" pop_box1 cursor">
                                            <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/plus.png" alt="" class="img-fluid plusbox">
                                        </div>
                                    </div>
                                </div>

                                <div id="cat_card_origin" class="swiper-slide slide2 d-none">
                                    <div class="pop_w">
                                        <div class="pop_box2">
                                            <div class="cat_namebox fs_24 fw_700">
                                                <div class="cat_name"></div>
                                                <div class="icon_sex"></div>
                                            </div>
                                            <div class="fs_18 pt-1">
                                                <span class="cat_specie_name">코리안숏헤어</span>, 
                                                <span class="cat_kg">6</span>
                                                kg
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>

                    <div class="col-6 px-6 pt-5_1 pb-6">
                        <a onclick="survey.movePage('#opening')">
                            <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/prev_btn.png" class="img-fluid cursor pc" alt="">
                            <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/prev_btn_mobile.png" class="img-fluid cursor mobile" alt="">
                        </a>
                    </div>
                    <div class="col-6 pr-6 pt-5_1 pb-6 text-right next_btn" onclick="survey.checkToCreating()">
                    </div>
                </div>
            </div>  

                <!--고양이 고르기-->
            <div id="creating" class="container-fluid mw_1200 d-none survey_pages">
                <div class="row align-items-center h-100 under_bar_box">
                    <div class="col-12 px-6 pt_40px pb_30px">
                        <div id="creating_title" class=" fs_40 fw_700"></div>
                    </div>

                    <div class="col-12 px-6 ">
                        <div class="row pb_30px m_col_100">
                            <div class="col-4 pl-0">
                                <div class="fs_18 pb-3">이름</div>
                                <input id="cat_name" type="text" class="form-control" placeholder="이름을 입력해 주세요." maxlength="10" onblur="survey.setCatData('name', this.value)">
                            </div>
                            <div class="col-4 pr-0">
                                <div class="fs_18 pb-3 m_pt_20">몸무게</div>
                                <input id="cat_kg" type="text" class="form-control" placeholder="몸무게를 소수점 1자리까지 입력해 주세요.(예: 2.3kg)" maxlength="4" onblur="survey.setCatData('kg', this.value)">
                            </div>
                            <div class="col-4 pl-0">
                                <div class="fs_18 pb-3">성별</div>
                                <ul class="select">
                                    <li>
                                        <input class="select_close" type="radio" name="is_male" id="option1-close"
                                            value="" />
                                        <span class="select_label select_label-placeholder">성별을 입력해 주세요.</span>
                                    </li>
                                    <li class="select_items z_10">
                                        <input class="select_expand" type="radio" name="is_male" id="option1-opener" />
                                        <label class="select_closeLabel" for="option1-close" onclick="survey.setCatData('is_male', null)"></label>

                                        <ul class="select_options">
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="is_male" id="is_male_0" onclick="survey.setCatData('is_male', 0)" />
                                                <label class="select_label" for="is_male_0">여</label>
                                            </li>

                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="is_male" id="is_male_1" onclick="survey.setCatData('is_male', 1)" />
                                                <label class="select_label" for="is_male_1">남</label>
                                            </li>
                                        </ul>
                                        <label class="select_expandLabel" for="option1-opener"></label>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="row pb_30px m_col_100">
                            <div class="col-4 pr-0">
                                <div class="fs_18 pb-3 m_pt_20">나이</div>
                                <ul class="select02">
                                    <li>
                                        <input class="select_close" type="radio" name="age" id="cat_age-close"
                                            value="" />
                                        <span class="select_label select_label-placeholder">나이를 선택해주세요.</span>
                                    </li>
                                    <li class="select_items z_10 z_10_m">
                                        <input class="select_expand" type="radio" name="age" id="cat_age-opener" />
                                        <label class="select_closeLabel" for="cat_age-close" onclick="survey.setCatData('age', null)"></label>

                                        <ul class="select_options">
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="모름" onclick="survey.setCatData('age', 6)" />
                                                <label class="select_label" for="모름">모름</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_0" onclick="survey.setCatData('age', 1)" />
                                                <label class="select_label" for="cat_age_0">1살 미만</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_1" onclick="survey.setCatData('age', 1)" />
                                                <label class="select_label" for="cat_age_1">1살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_2" onclick="survey.setCatData('age', 2)" />
                                                <label class="select_label" for="cat_age_2">2살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_3" onclick="survey.setCatData('age', 3)" />
                                                <label class="select_label" for="cat_age_3">3살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_4" onclick="survey.setCatData('age', 4)" />
                                                <label class="select_label" for="cat_age_4">4살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_5" onclick="survey.setCatData('age', 5)" />
                                                <label class="select_label" for="cat_age_5">5살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_6" onclick="survey.setCatData('age', 6)" />
                                                <label class="select_label" for="cat_age_6">6살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_7" onclick="survey.setCatData('age', 7)" />
                                                <label class="select_label" for="cat_age_7">7살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_8" onclick="survey.setCatData('age', 8)" />
                                                <label class="select_label" for="cat_age_8">8살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_9" onclick="survey.setCatData('age', 9)" />
                                                <label class="select_label" for="cat_age_9">9살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_10"  onclick="survey.setCatData('age', 10)" />
                                                <label class="select_label" for="cat_age_10">10살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_11"  onclick="survey.setCatData('age', 11)" />
                                                <label class="select_label" for="cat_age_11">11살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_12"  onclick="survey.setCatData('age', 12)" />
                                                <label class="select_label" for="cat_age_12">12살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_13" onclick="survey.setCatData('age', 13)" />
                                                <label class="select_label" for="cat_age_13">13살</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="age" id="cat_age_13_over" onclick="survey.setCatData('age', 13)" />
                                                <label class="select_label" for="cat_age_13_over">13살이상</label>
                                            </li>
                                        </ul>
                                        <label class="select_expandLabel" for="cat_age-opener"></label>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-4 pl-0">
                                <div class="fs_18 pb-3">품종</div>
                                <ul class="select02">
                                    <li>
                                        <input class="select_close" type="radio" name="id_species" id="cat_breed-close" />
                                        <span class="select_label select_label-placeholder">품종을 선택해 주세요</span>
                                    </li>
                                    <li class="select_items z_10_m2">
                                        <input class="select_expand" type="radio" id="cat_breed-opener" name="id_species" />
                                        <label class="select_closeLabel" for="cat_breed-close" onclick="survey.setCatData('id_species', null)"></label>
                                        <ul id="species_list" class="select_options">

                                        </ul>
                                        <label class="select_expandLabel" for="cat_breed-opener"></label>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-4 pr-0">
                                <div class="fs_18 pb-3 m_pt_20">중성화 여부</div>
                                <ul class="select03">
                                    <li>
                                        <input class="select_close" type="radio" name="is_neutering" id="cat_neuter-close"/>
                                        <span class="select_label select_label-placeholder">중성화 여부를 선택해주세요.</span>
                                    </li>
                                    <li class="select_items z_13">
                                        <input class="select_expand" type="radio" name="is_neutering" id="cat_neuter-opener"/>
                                        <label class="select_closeLabel" for="cat_neuter-close" onclick="survey.setCatData('is_neutering', null)"></label>
                                        <ul class="select_options">
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="is_neutering" id="is_neutering_unknown" onclick="survey.setCatData('is_neutering', false)" />
                                                <label class="select_label" for="is_neutering_unknown">모름</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="is_neutering" id="is_neutering_0" onclick="survey.setCatData('is_neutering', 1)" />
                                                <label class="select_label" for="is_neutering_0">완료</label>
                                            </li>
                                            <li class="select_option">
                                                <input class="select_input" type="radio" name="is_neutering" id="is_neutering_1" onclick="survey.setCatData('is_neutering', false)" />
                                                <label class="select_label" for="is_neutering_1">미완료</label>
                                            </li>
                                        </ul>
                                        <label class="select_expandLabel" for="cat_neuter-opener"></label>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="row m_col_100">
                        </div>
                    </div>


                    <div class="col-6 px-6 pt-5_1 pb-6" onclick="survey.movePage('#selecting')">
                        <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/prev_btn.png" class="img-fluid cursor pc" alt="">
                        <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/prev_btn_mobile.png" class="img-fluid cursor mobile" alt="">
                    </div>
                    <div class="col-6 pr-6 pt-5_1 pb-6 text-right next_btn" onclick="survey.postCat()">
                    </div>
                </div>
            </div>

            <div id="questing" class="container-fluid mw_1200 survey_pages d-none">
                <div class="row align-items-center h-100 under_bar_box">
                    <div id="question_box" class="col-12 px-6">
                    </div>

                    <div class="col-6 px-6 pt-5_1 pb-6" onclick="survey.moveQuestion(false)">
                        <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/prev_btn.png" class="img-fluid cursor pc" alt="">
                        <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/prev_btn_mobile.png" class="img-fluid cursor mobile" alt="">
                    </div>
                    <div class="col-6 pr-6 pt-5_1 pb-6 text-right next_btn">
                    </div>                    
                </div>
            </div>

            <div id="ending" class="container-fluid mw_1200 survey_pages d-none">
                <div class="row align-items-center h-100 ">
                    <div class="col-12 text-right pt_2rem pr-4 mpt-4 mobile">
                        <button type="button" class="btn">
                            <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/close.png" alt="" class="img-fluid">
                        </button>
                    </div>
                    <div class="col-12 text-center fs_40 fw_700 pt-10">
                        <span class="point_color selected_cat_name"></span>의 설문 내용을 분석하고 있습니다.
                    </div>

                    <div class="col">
                        <div id="circle_loading"></div>
                    </div>

                    <div class="col-12 pt-0 pb-10 text-center fs_16 color_888">
                        <div class="fw_700 pb-1">까리는 정략/정성적인 자료들을 근거한 알고리즘을 토대로 간식을 구성해드리고 있습니다.</div>
                        예방/관리에 도움이 되는 제품들이나 질병 치료를 희망하시는 분은 전문의료기관을 통해 처방받는 것을 권장합니다.
                    </div>
                </div>                
            </div>
          
        </div>
    </div>
</div>



<script>

$(()=>{
    survey.init();
});
  
var survey = {
    progress : 0,
    surveyData : null,
    mySurveyData : {},
    selectedCat : 0,
    survey_pages : [],
    catData : {},
    guageWidth : 0,
    ajaxEnd : false,

    movePage : (idTarget)=>{
        //진행바 제어
        if(idTarget == '#opening' || idTarget == "#ending") $('#progress_box').addClass('d-none');
        else    $('#progress_box').removeClass('d-none');
        //고양이 이름 새기기
        if(idTarget == "#questing"){
            $('.selected_cat_name').html($('#cat_name').val());
            $('#announce0').addClass('d-none');
            $('#announce1').removeClass('d-none');
        }else{
            $('#announce0').removeClass('d-none');
            $('#announce1').addClass('d-none');
        }
        
        //그외의 경우

        switch(idTarget){
            case '#selecting':
                survey.drawCatCards();
                survey.drawSpeciesList();
                survey.animateBar(60);
                break;
            case "#creating" :
                survey.animateBar(140);
                break;
            case "#ending" :
                bar.animate(1);
                survey.postSurveys();
                break;    
        }
        survey.survey_pages.addClass('d-none');
        $(idTarget).removeClass('d-none');
    },

    addAnswer : (q, a)=>{
        //값입력
        if(survey.questions.find(e=> e.id == q).input_type == 'checkbox'){            
            if(!survey.mySurveyData["q"+q].includes(a)){
                survey.mySurveyData["q"+q] += String(a) + ",";
            }else{
                survey.mySurveyData["q"+q] = survey.mySurveyData["q"+q].replace(a+",", "");
            }
        }else{
            if(survey.mySurveyData["q"+q] == a){
                survey.mySurveyData["q"+q] = "";
                $('#q'+q+"_"+a).prop('checked', false);
            } 
            else survey.mySurveyData["q"+q] = a;
        }
        console.log(survey.mySurveyData);

        survey.verifyQuestions(q);
    },



    moveQuestion : (isNext) =>{        
        $('#questing .next_btn').removeClass('active').off('click');

        //앞막음
        if(!isNext && survey.progress == 1){
            survey.progress--;
            survey.movePage("#creating");
            return false;
        }
        //뒤 엔딩으로 보냄
        if(isNext && survey.progress == survey.questions.length){
            //갚이 다 차있는지 체크
            survey.movePage("#ending"); 
            return true;
        }
        if(isNext){
            survey.progress++;
        }else{
            survey.progress--;
        }
        $('.questions').addClass('d-none');
        $('#question'+survey.questions[survey.progress-1].id).removeClass('d-none');
        survey.animateBar($('.pop_loader').width()/12*(3+survey.questions[survey.progress-1].category));
        survey.verifyQuestions(survey.questions[survey.progress-1].id);
    },



    init : ()=> {
        survey.progress = 0;
        survey.selectedCat = -1,
        survey.survey_pages = $('.survey_pages');
        survey.guageWidth = $('.pop_loader').width();

        $.ajax({
            url : serverUrl+'/api/surveys',
            type : 'GET',
            dataType : 'jsonp',
            jsonp : "callback",
            async : false,
        })
        .done(function(data) {
            console.log('Survey Loaded');
            survey.questions = data;
            survey.questions.forEach((item, i, array)=>{
                survey.mySurveyData["q"+item.id] = "";
            });     
            survey.drawQuestions();
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
            console.log('AJAX Error!' + textStatus + " : " + errorThrown);
            alert('서버와의 접속에 실패했습니다.');
        });        
    },

    setSelectedCat : (id)=>{
        let $thisbox = $('#cat_card'+id);
        $('.pop_box2').removeClass('toggle');
        $('.icon_sex').removeClass('active');
        if(survey.selectedCat == id){
            survey.selectedCat = -1;
        }else{
            survey.selectedCat = id;
            $thisbox.find('.pop_box2').addClass('toggle');
            $thisbox.find('.icon_sex').addClass('active');
        }
        console.log("THIS CAT : ", survey.selectedCat);
        if(survey.selectedCat == -1) $('#selecting .next_btn').removeClass('active');
        else $('#selecting .next_btn').addClass('active');
    },

    checkToCreating : (isNew)=>{
        if(isNew) survey.selectedCat = 0;
        switch(survey.selectedCat){
            case -1 : 
                alert('반려묘를 선택해주세요.');
                break;
            default : 
                survey.initCreating();
                survey.movePage('#creating');
                break;
        }        
    },



    initCreating : ()=>{
        let $title = $('#creating_title');
        if(survey.selectedCat > 0){
            const originCat = cat.cats.find(e => e.id == survey.selectedCat); 
            $title.html(originCat.name+"의 정보 수정하기");
            survey.catData['name'] = originCat.name;
            survey.catData['kg'] = originCat.kgx10;
            survey.catData['age'] = originCat.age;
            survey.catData['is_male'] = originCat.is_male;
            survey.catData['is_neutering'] = originCat.is_neutering;
            survey.catData['id_species'] = originCat.id_species;
            $('#cat_name').val(originCat.name);
            $('#cat_kg').val(parseFloat(originCat.kgx10 / 10));
            $('#cat_age_'+originCat.age).trigger('click');
            $('#is_male_'+(+originCat.is_male).toString()).trigger('click');
            $('#is_neutering_'+(+originCat.is_neutering).toString()).trigger('click');
            $('#id_species_'+(+originCat.is_male).toString()).trigger('click');
            survey.verifyInputs();
        }else{
            $title.html('새로운 반려묘 등록하기');            
            survey.catData['name'] = null;
            survey.catData['kg'] = null;
            survey.catData['age'] = null;
            survey.catData['is_male'] = null;
            survey.catData['is_neutering'] = null;
            survey.catData['id_species'] = null;
            $('#cat_name').val('');
            $('#cat_kg').val('');
            $('.select_closeLabel').trigger('click');

        }
    },
            
    setCatData : (key, val) => {
        if(key == 'name'){
            survey.catData['name'] = $('#cat_name').val();
        }else if(key == 'kg'){
            let kgStr = $('#cat_kg').val();
            if(kgStr.substr(-2, 1) != "."){
                alert('몸무게가 바르지 않습니다!');
                $('#cat_kg').val('');
            }
            survey.catData['kg'] = kgStr;

        }else{
            survey.catData[key] = val;
        }
        console.log("CatData :", survey.catData);
        survey.verifyInputs();
    },

    verifyInputs : () => {
        //값이 모두 들어왔나 체크
        if(util.isEmpty(survey.catData['name']) || 
           util.isEmpty(survey.catData['kg']) || 
           util.isEmpty(survey.catData['age']) ||
           util.isEmpty(survey.catData['is_male'])  ||
           util.isEmpty(survey.catData['is_neutering'])  ||
           util.isEmpty(survey.catData['id_species'])
        ){
            $("#creating .next_btn").removeClass('active');
            return false;
        }else{
            $("#creating .next_btn").addClass('active');
            return true;
        }
    },


    verifyQuestions : (q)=>{
        $('#questing .next_btn').removeClass('active').off('click');
            //선택 질문일떄                                        //값이 차있으면
        if(!survey.questions.find(e=> e.id == q).is_required || survey.mySurveyData["q"+q].length != 0){
            $('#questing .next_btn').addClass('active').click(()=>{survey.moveQuestion(true)});
            return true;
        }else{
            return false;
        }
    },


    animateBar : (goal) =>{
        $('#pop_loader_bar').animate({width : goal}, 2000);
        $('.pop_loader_top').animate({left : goal-27}, 2000);
    },

    drawCatCards : ()=>{
        survey.selectedCat = -1; //노선택 상태
        let $origin = $('#cat_card_origin').clone();
        for(let catOne of cat.cats){
            $card = $origin.clone().attr({id : "cat_card"+catOne.id, data_id_cat : catOne.id}).removeClass('d-none');
            $card.find('.cat_name').html(catOne.name);
            let sexStr = catOne.is_male ? "xy" : "xx"
            $card.find('.icon_sex').addClass(sexStr);
            $card.find('.cat_specie_name').html(species.getName(catOne.id_species));
            $card.find('.cat_kg').html(catOne.kgx10 / 10);
            $card.click(()=>{survey.setSelectedCat(catOne.id)});
            $('#cat_card0').after($card);
        }
        $('#cat_card_origin').remove();
        survey.setSelectedCat(-1);
        // 스와이퍼
        var catSwiper = new Swiper('.catname_swiper', {
            slidesPerView: 'auto',
            centeredSlides: true,
            spaceBetween: 30,
        });
    },
    drawSpeciesList : ()=>{
        let $speciesList = $('#species_list').empty();
        //품종 추가
        for (const item of species.data){
            let $li = $('<li>').addClass('select_option');
            let $input = $('<input>').addClass('select_input').attr({ id : "id_species_"+item.id, type: "radio", name : "id_species", value: item.id}).click(()=>{survey.setCatData('id_species', item.id);});
            let $label = $('<label>').addClass('select_label').attr({for : "id_species_"+item.id }).html(item.name);
            $li.append([$input, $label]);
            $speciesList.append($li);
        }
    },

    drawQuestions : () =>{
        let $body = $('#question_box');
        let $originTip = $('#origin_tip');
        survey.questions.forEach((question, i) =>{
            let $page = $('<div>').attr({id : "question"+question.id} ).addClass('questions d-none');
            let $qBox = $('<div>').addClass('pt_40px');
            let $qNo = $('<span>').addClass('fs_24 fw_700 point_color').html("Q"+(i+1)+". ");
            let $qDescription = $('<span>').addClass('fs_24 fw_700').html(question.description);
            $qBox.append([$qNo, $qDescription])
            if(!question.is_required){
                let $qIsNotRequired = $('<span>').addClass('fs_24 fw_400').css({color : "#D1D0D0"}).html('  (선택)');
                    $qBox.append($qIsNotRequired);
            }

            let $tipBox = $('<div>').addClass('col-12 pt-3 px-6 tip_box');
            if(question.tip != null){
                $tipBox = $originTip.clone();
                $tipBox.removeClass('d-none').find('.tip_description').html(question.tip);
            }

            let $aBox = $('<div>').addClass('pt_2rem answers');
            switch(question.input_type){
                case 'textarea' :
                    let $input = $('<textarea>').attr({id: "q"+question.id, rows : 3, placeholder : "직접 입력하기"}).addClass(["form-control", "mt_2rem"]).blur(()=>{survey.addAnswer(question.id, $("#q"+question.id).val())});
                    $aBox.append($input);
                    break;
                case 'checkbox' :
                    question.answers.forEach((answer, j)=>{
                        let $input = $('<input>').attr({id: "q"+question.id+"_"+(j+1), type: "checkbox"}).click(()=>{survey.addAnswer(question.id, j+1)});
                        let $label = $('<label>').attr({for: "q"+question.id+"_"+(j+1)}).addClass("pb-4").html(answer.description);
                        $aBox.append($input, $label);
                    });
                    break;
                case 'radio' :
                    $aBox.addClass('have_radio');
                    question.answers.forEach((answer, j)=>{
                        let $input = $('<input>').attr({id: "q"+question.id+"_"+(j+1), name : "q"+question.id, type: "radio"}).click(()=>{survey.addAnswer(question.id, j+1)});
                        let $label = $('<label>').attr({for: "q"+question.id+"_"+(j+1)}).addClass('["mr-3", "mr_3_m2"]').html(answer.description);
                        $aBox.append($input, $label);
                    });
                    break;         
            }
            $page.append([$qBox, $tipBox, $aBox]);

            $body.append($page);
 
        });
 
//        $('#origin_question, #origin_tip').remove();
    },

    postCat : () => {
        //값이 안찼는데 들어오는 경우
        if(!survey.verifyInputs()){
            alert('정보를 입력해주세요!');
            return false;
        }
        //비로그인자일 경우 아이디칸에 세션아이디로 대체
        if(user.id == null){
            user.id = util.getSessionId;
        }
    
        let type;
        survey.catData['id_ollysite'] = user.id;        
        if(survey.selectedCat != 0 ){
            survey.catData['id'] = survey.selectedCat;
            type = "PATCH";
        }else{            
            type = "POST";
        }
        $.ajax({
            url :  serverUrl + "/api/cat",
            type : type,
            data : survey.catData,
            statusCode: {
                200: (data) => {
                    cat.getCatsData();
                    console.log("Cat Updated.", cat.cats); 
                    survey.movePage('#questing');
                    survey.moveQuestion(true);
            },
                201: (data) => { 
                    cat.getCatsData();
                    console.log("Cat Inserted.", cat.cats); 
                    survey.selectedCat = data.id;
                    survey.movePage('#questing');
                    survey.moveQuestion(true);
            },
            }
        }).fail((jqXHR, textStatus, errorThrown)=>{
            console.log('Cat Blocked!!' +textStatus + " : " + errorThrown);
            alert('고양이 정보 등록에 실패했습니다!');
        })
    },

    postSurveys : ()=>{
        var data = JSON.stringify(survey.mySurveyData);
        console.log(data)
        $.ajax({
            url : serverUrl + "/api/surveys",
            type : "POST",
            data : {id : survey.selectedCat, data: data },
            dataType : 'JSON',
            statusCode: {
                201: (data) => {
                    console.log("Survey Inserted."); 
                    survey.postDisease();
               }
             }            
        }).fail((jqXHR, textStatus, errorThrown)=>{
            console.log('Survey Blocked!!' +textStatus + " : " + errorThrown);
            alert('고양이 정보 등록에 실패했습니다!');
        })
    },

    postDisease : ()=>{
        console.log("Disease Start to", survey.selectedCat);
        $.ajax({
            url : serverUrl + "/api/surveys/disease",
            type : "POST",
            data : {id_cat : survey.selectedCat},
            statusCode: {
                201: (data) => {
                    console.log("Survey-Disease Inserted.");
                    setTimeout(()=>{
                        location.href='/page/?M2_IDX=26046&id='+survey.selectedCat;
                    }, 10000)
               }
             }
        }).fail((jqXHR, textStatus, errorThrown)=>{
            console.log('Survey ERROR!!' +textStatus + " : " + errorThrown);
            alert('고양이 정보 등록에 실패했습니다!');
        })
    }

}

var bar = new ProgressBar.Circle(circle_loading, {
    color: '#6E9357',
    strokeWidth: 6,
    trailWidth: 6,
    easing: 'easeInOut',
    duration: 7500,
    text: {
        autoStyleContainer: false
    },
    from: { color: '#6E9357', width: 6 },
    to: { color: '#6E9357', width: 6 },
    step: function (state, circle) {
        circle.path.setAttribute('stroke', state.color);
        circle.path.setAttribute('stroke-width', state.width);

        var value = Math.round(circle.value() * 100);
        if (value === 0) {
            circle.setText('');
        } else {
            circle.setText(value);
        }
    }
});

</script>




<div id="origin_tip" class="point_color d-none pt-4">
    <div class="tip_box row align-items-center h-100">
        <div class="px-0">
            <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/cat_head.png" alt="" class="img-fluid">
        </div>
        <div class="pl-1 line_14">
            <span class="fs_16 fw_700 pl-2">Tip. </span>
            <span class="fs_16 tip_description"></span>    
        </div>           
    </div>
</div>
